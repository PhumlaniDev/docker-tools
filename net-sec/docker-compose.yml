services:
  unbound:
    image: klutchell/unbound:latest
    container_name: unbound
    restart: unless-stopped
    # depends_on:
    #   redis:
    #     condition: service_healthy
    networks:
      net_sec:
        ipv4_address: 10.50.0.10
    volumes:
      - ./unbound/config:/etc/unbound/custom.conf.d:ro
    environment:
      - REDIS_PORT=6379
    healthcheck:
      test: ["CMD", "drill", "@127.0.0.1", "example.com"]
      interval: 30s
      timeout: 10s
      retries: 3

  adguard:
    image: adguard/adguardhome:latest
    container_name: adguard
    restart: unless-stopped
    depends_on:
      unbound:
        condition: service_healthy
    networks:
      net_sec:
        ipv4_address: 10.50.0.5
    volumes:
      - ./adguard/work:/opt/adguardhome/work
      - ./adguard/conf:/opt/adguardhome/conf
    ports:
      - "8053:53/tcp" # DNS
      - "8053:53/udp"
      - "8082:80/tcp" # HTTP for admin (change to HTTPS in production)
      - "443:443/tcp" # HTTPS for admin
      - "853:853/tcp" # DNS-over-TLS
      - "853:853/udp" # DNS-over-QUIC (optional)
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  wireguard:
    image: linuxserver/wireguard:latest
    container_name: wireguard
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    environment:
      - PUID=1000 # Your user ID for file permissions
      - PGID=1000 # Your group ID
      - TZ=Africa/Johannesburg # Adjust to your timezone, e.g., America/New_York
      # - SERVERURL=auto # Or your public IP/domain for client configs
      - SERVERPORT=51820
      - PEERS=5 # Number of initial client configs to generate
      - PEERDNS=10.50.0.5 # AdGuard Home's static IP
      - INTERNAL_SUBNET=10.13.13.0/24 # WireGuard client subnet (avoid conflicts)
      - ALLOWEDIPS=0.0.0.0/0 # Full tunnel; change to 172.20.0.0/24 for split-tunnel DNS only
      - LOG_CONFS=true # Log generated configs
    volumes:
      - ./wireguard/config:/config
      - /lib/modules:/lib/modules:ro # For kernel modules if needed
    ports:
      - "51820:51820/udp" # WireGuard port (forward this in your router/firewall)
    sysctls:
      - net.ipv4.conf.all.src_valid_mark=1
    restart: unless-stopped
    depends_on:
      adguard:
        condition: service_healthy
    networks:
      net_sec:
        ipv4_address: 10.50.0.2
    healthcheck:
      test: ["CMD-SHELL", "wg show interfaces | grep -q wg0 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s # Give time for interface to come up

networks:
  net_sec:
    driver: bridge
    ipam:
      config:
        - subnet: 10.50.0.0/16
